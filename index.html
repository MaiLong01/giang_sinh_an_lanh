<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Christmas Gifts & Lights</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>

<style>
body {
    margin: 0;
    overflow: hidden;
    background: #000;
    font-family: 'Segoe UI', sans-serif;
}

#canvas-container {
    width: 100%;
    height: 100vh;
}

/* ================= UI ================= */
#ui-layer {
    position: absolute;
    bottom: 5vh;
    width: 100%;
    text-align: center;
    pointer-events: none;
    z-index: 100;
    padding: 0 12px;
    box-sizing: border-box;
}

.badge {
    display: inline-block;
    background: rgba(0,0,0,0.7);
    border: 2px solid #FFD700;
    color: #FFD700;
    padding: 8px 18px;
    border-radius: 999px;
    font-size: clamp(14px, 4vw, 18px);
    font-weight: bold;
    margin-bottom: 8px;
    box-shadow: 0 0 15px rgba(255,215,0,0.5);
}

.guide {
    font-size: clamp(11px, 3vw, 13px);
    color: #ccc;
    margin-bottom: 12px;
}

button {
    pointer-events: auto;
    cursor: pointer;
    background: linear-gradient(#D32F2F, #8B0000);
    color: #fff;
    border: 2px solid #FFD700;
    padding: 12px 28px;
    border-radius: 999px;
    font-size: clamp(14px, 4vw, 16px);
    font-weight: bold;
    box-shadow: 0 0 20px rgba(255,0,0,.6);
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

/* ============ Camera Preview ============ */
#camera-preview {
    position: absolute;
    top: 10px;
    right: 10px;
    width: min(35vw, 140px);
    aspect-ratio: 4/3;
    border: 2px solid rgba(255,0,0,.5);
    border-radius: 8px;
    transform: scaleX(-1);
    opacity: .6;
}

video { display: none; }
</style>
</head>

<body>
<div id="ui-layer">
    <div id="status" class="badge">üéÑ Gi√°ng Sinh An L√†nh üéÑ</div>
    <div class="guide">
        üñê Bung c√¢y | üëå Xem ·∫£nh | ‚úä Thu c√¢y
    </div>
    <button id="btnStart">B·∫ÆT ƒê·∫¶U</button>
</div>

<div id="canvas-container"></div>
<video class="input_video"></video>
<canvas id="camera-preview"></canvas>

<script>
/* ================= CONFIG ================= */
const isMobile = window.innerWidth < 768;

const CONFIG = {
    goldCount: isMobile ? 1200 : 2000,
    redCount: isMobile ? 180 : 300,
    giftCount: isMobile ? 80 : 150,
    explodeRadius: isMobile ? 45 : 65,
    photoOrbitRadius: isMobile ? 18 : 25,
    treeHeight: isMobile ? 55 : 70,
    treeBaseRadius: isMobile ? 25 : 35
};

const MUSIC_URL = "./audio.mp3";
const photoFiles = [
    "./image1.jpeg",
    "./image2.jpeg",
    "./image3.jpeg",
    "./image4.jpeg",
    "./image5.jpeg"
];

/* ================= THREE ================= */
let scene, camera, renderer;
let groupGold, groupRed, groupGift;
let photoMeshes = [];
let state = "TREE";
let selectedIndex = 0;
let handX = 0.5;

const loader = new THREE.TextureLoader();
const photoTextures = photoFiles.map(f => loader.load(f));

function makeTexture(type) {
    const c = document.createElement("canvas");
    c.width = c.height = 128;
    const x = c.getContext("2d");

    if (type === "gold") {
        const g = x.createRadialGradient(64,64,0,64,64,40);
        g.addColorStop(0,"#fff");
        g.addColorStop(.5,"#FFD700");
        g.addColorStop(1,"transparent");
        x.fillStyle = g;
        x.fillRect(0,0,128,128);
    }
    if (type === "red") {
        const g = x.createRadialGradient(64,64,0,64,64,50);
        g.addColorStop(0,"#FFAAAA");
        g.addColorStop(.4,"#FF0000");
        g.addColorStop(1,"transparent");
        x.fillStyle = g;
        x.fillRect(0,0,128,128);
    }
    if (type === "gift") {
        x.fillStyle="#D32F2F"; x.fillRect(20,20,88,88);
        x.fillStyle="#FFD700";
        x.fillRect(54,20,20,88);
        x.fillRect(20,54,88,20);
    }
    return new THREE.CanvasTexture(c);
}

const textures = {
    gold: makeTexture("gold"),
    red: makeTexture("red"),
    gift: makeTexture("gift")
};

function init3D() {
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(
        60,
        window.innerWidth/window.innerHeight,
        0.1,
        1000
    );
    camera.position.z = isMobile ? 120 : 100;

    renderer = new THREE.WebGLRenderer({ antialias:true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio,1.5));
    document.getElementById("canvas-container").appendChild(renderer.domElement);

    groupGold = createParticles("gold", CONFIG.goldCount, 2);
    groupRed  = createParticles("red", CONFIG.redCount, 3);
    groupGift = createParticles("gift", CONFIG.giftCount, 3);

    createPhotos();
    animate();
}

function createParticles(type, count, size) {
    const pos = [];
    const tree = [];
    const explode = [];

    for(let i=0;i<count;i++){
        const h = Math.random()*CONFIG.treeHeight;
        const y = h - CONFIG.treeHeight/2;
        const r = (1-h/CONFIG.treeHeight)*CONFIG.treeBaseRadius*Math.random();
        const a = Math.random()*Math.PI*2;

        const x = r*Math.cos(a);
        const z = r*Math.sin(a);

        tree.push(x,y,z);
        pos.push(x,y,z);

        const rr = CONFIG.explodeRadius*Math.random();
        explode.push(
            rr*Math.cos(a),
            (Math.random()-.5)*rr,
            rr*Math.sin(a)
        );
    }

    const g = new THREE.BufferGeometry();
    g.setAttribute("position", new THREE.Float32BufferAttribute(pos,3));
    g.userData={tree,explode};

    const m = new THREE.PointsMaterial({
        size,
        map:textures[type],
        transparent:true,
        depthWrite:false,
        blending: type==="gift" ? THREE.NormalBlending : THREE.AdditiveBlending
    });

    const p = new THREE.Points(g,m);
    scene.add(p);
    return p;
}

function createPhotos() {
    const geo = new THREE.PlaneGeometry(8,8);
    photoTextures.forEach((t,i)=>{
        const m = new THREE.MeshBasicMaterial({ map:t, side:THREE.DoubleSide });
        const mesh = new THREE.Mesh(geo,m);
        mesh.visible=false;
        scene.add(mesh);
        photoMeshes.push(mesh);
    });
}

function updateGroup(group, mode, speed, rot) {
    const pos = group.geometry.attributes.position.array;
    const tgt = group.geometry.userData[mode==="TREE"?"tree":"explode"];
    for(let i=0;i<pos.length;i++){
        pos[i]+=(tgt[i]-pos[i])*speed;
    }
    group.geometry.attributes.position.needsUpdate=true;
    group.rotation.y += mode==="TREE" ? .003 : (rot-group.rotation.y)*.05;
}

function animate() {
    requestAnimationFrame(animate);
    const rot = (handX-.5)*2.5;

    updateGroup(groupGold,state,.06,rot);
    updateGroup(groupRed,state,.06,rot);
    updateGroup(groupGift,state,.06,rot);

    if(state==="EXPLODE"){
        const step = Math.PI*2/photoMeshes.length;
        let maxZ=-999;
        photoMeshes.forEach((m,i)=>{
            m.visible=true;
            const a=i*step+groupGold.rotation.y;
            m.position.set(
                Math.sin(a)*CONFIG.photoOrbitRadius,
                Math.sin(Date.now()*0.002+i)*2,
                Math.cos(a)*CONFIG.photoOrbitRadius
            );
            m.lookAt(camera.position);
            if(m.position.z>maxZ){maxZ=m.position.z;selectedIndex=i;}
        });
    }

    if(state==="PHOTO"){
        photoMeshes.forEach((m,i)=>{
            if(i===selectedIndex){
                m.position.lerp(new THREE.Vector3(0,0,60),.1);
                m.scale.lerp(new THREE.Vector3(5,5,5),.1);
            } else m.scale.lerp(new THREE.Vector3(0,0,0),.1);
        });
    }

    renderer.render(scene,camera);
}

/* ================= HAND TRACK ================= */
document.getElementById("btnStart").onclick = async ()=>{
    document.getElementById("btnStart").style.display="none";
    if(document.documentElement.requestFullscreen){
        document.documentElement.requestFullscreen().catch(()=>{});
    }

    new Audio(MUSIC_URL).play().catch(()=>{});
    init3D();

    const video=document.querySelector(".input_video");
    const canvas=document.getElementById("camera-preview");
    const ctx=canvas.getContext("2d");

    const hands=new Hands({ locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
    hands.setOptions({ maxNumHands:1, minDetectionConfidence:.5 });

    hands.onResults(r=>{
        ctx.drawImage(r.image,0,0,canvas.width,canvas.height);
        if(r.multiHandLandmarks.length){
            const lm=r.multiHandLandmarks[0];
            handX=lm[9].x;
            const pinch=Math.hypot(lm[4].x-lm[8].x,lm[4].y-lm[8].y);
            state = pinch<.05 ? "PHOTO" : "EXPLODE";
        } else state="TREE";
    });

    const cam=new Camera(video,{
        onFrame:async()=>hands.send({image:video}),
        width:320,height:240
    });
    cam.start();
};

window.onresize=()=>{
    camera.aspect=window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth,window.innerHeight);
};
</script>
</body>
</html>
